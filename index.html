<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Activity Code Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Proxima+Nova&display=swap" rel="stylesheet">
  <style>
    /* [Previous CSS styles remain exactly the same] */
    body {
      font-family: 'Proxima Nova', Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      background-color: #f5f5f5;
    }
    /* [Rest of your CSS...] */
  </style>
</head>
<body>
  <!-- [Previous HTML structure remains the same until the script section] -->
  
  <script>
    // Configuration with error checks
    const API_BASE_URL = 'https://api.mypurecloud.ie';
    const CLIENT_ID = 'f93a488c-73e9-40cf-b4fd-5c05ff043c81';
    const CLIENT_SECRET = 'G0qSDsjAtCutt5W-297Yqrwz9n4q3g3YdwpfnbchGcQ';

    // Verify configuration
    if (!CLIENT_ID || !CLIENT_SECRET) {
      alert('Error: Client ID or Secret not configured!');
      console.error('Client credentials not properly configured');
    }

    // Enhanced API Service
    const apiService = {
      async getAccessToken() {
        try {
          const response = await fetch(`${API_BASE_URL}/oauth/token`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams({
              grant_type: 'client_credentials',
              client_id: CLIENT_ID,
              client_secret: CLIENT_SECRET
            })
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.error_description || 
                          errorData.error || 
                          `HTTP ${response.status} - Authentication failed`);
          }

          const data = await response.json();
          return data.access_token;
        } catch (error) {
          console.error('Authentication Error:', error);
          throw new Error(`Failed to get access token: ${error.message}`);
        }
      },

      async fetchBusinessUnits(token) {
        try {
          const response = await fetch(`${API_BASE_URL}/api/v2/workforcemanagement/businessunits?pageSize=100`, {
            headers: {
              'Authorization': `Bearer ${token}`,
              'Content-Type': 'application/json'
            }
          });

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || 
                          `HTTP ${response.status} - Failed to fetch business units`);
          }

          return await response.json();
        } catch (error) {
          console.error('Fetch Business Units Error:', error);
          throw new Error(`Failed to fetch business units: ${error.message}`);
        }
      },

      async createActivityCode(token, businessUnitId, activityData) {
        try {
          const response = await fetch(
            `${API_BASE_URL}/api/v2/workforcemanagement/businessunits/${businessUnitId}/activitycodes`,
            {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json',
              },
              body: JSON.stringify(activityData)
            }
          );

          if (!response.ok) {
            const errorData = await response.json().catch(() => ({}));
            throw new Error(errorData.message || 
                          `HTTP ${response.status} - Failed to create activity code`);
          }

          return await response.json();
        } catch (error) {
          console.error('Create Activity Code Error:', error);
          throw new Error(`Failed to create activity code: ${error.message}`);
        }
      }
    };

    // UI Controller
    const appController = {
      async init() {
        try {
          this.setupEventListeners();
          await this.loadBusinessUnits();
        } catch (error) {
          this.showError(`Initialization failed: ${error.message}`);
        }
      },

      setupEventListeners() {
        document.getElementById('create-button').addEventListener('click', () => {
          this.createActivityCode().catch(error => {
            this.showError(error.message);
          });
        });
      },

      async loadBusinessUnits() {
        this.showMessage('Loading business units...', 'loading');
        document.getElementById('create-button').disabled = true;

        try {
          const token = await apiService.getAccessToken();
          const data = await apiService.fetchBusinessUnits(token);
          
          const businessUnitsSelect = document.getElementById('business-units');
          businessUnitsSelect.innerHTML = '';
          
          if (data.entities && data.entities.length > 0) {
            data.entities.forEach(unit => {
              if (unit.name) {
                const option = document.createElement('option');
                option.value = unit.id;
                option.textContent = unit.name;
                businessUnitsSelect.appendChild(option);
              }
            });
            this.showMessage('Business units loaded successfully', 'success');
            document.getElementById('create-button').disabled = false;
          } else {
            throw new Error('No business units found');
          }
        } catch (error) {
          document.getElementById('business-units').innerHTML = 
            '<option value="" disabled>Failed to load business units</option>';
          throw error;
        }
      },

      async createActivityCode() {
        // Validate inputs
        const name = document.getElementById('activity-name').value.trim();
        const category = document.getElementById('category').value;
        const selectedUnits = Array.from(document.getElementById('business-units').selectedOptions);
        
        if (!name) throw new Error('Activity name is required');
        if (!category) throw new Error('Category is required');
        if (selectedUnits.length === 0) throw new Error('Select at least one business unit');

        this.showMessage('Creating activity code...', 'loading');
        document.getElementById('create-button').disabled = true;

        try {
          const token = await apiService.getAccessToken();
          const activityData = this.getActivityDataFromForm();
          
          const results = [];
          for (const unit of selectedUnits) {
            try {
              const result = await apiService.createActivityCode(token, unit.value, activityData);
              results.push({ success: true, unit: unit.textContent, data: result });
            } catch (error) {
              results.push({ success: false, unit: unit.textContent, error: error.message });
            }
          }

          this.showCreationResults(results);
        } finally {
          document.getElementById('create-button').disabled = false;
        }
      },

      getActivityDataFromForm() {
        return {
          name: document.getElementById('activity-name').value.trim(),
          category: document.getElementById('category').value,
          lengthInMinutes: parseInt(document.getElementById('length').value) || null,
          countsAsPaidTime: document.getElementById('paid-time').checked,
          countsAsWorkTime: document.getElementById('work-time').checked,
          agentTimeOffSelectable: document.getElementById('time-off-selectable').checked,
          countsTowardShrinkage: document.getElementById('shrinkage').checked,
          plannedShrinkage: document.getElementById('planned-shrinkage').checked,
          interruptible: document.getElementById('interruptible').checked
        };
      },

      showCreationResults(results) {
        const successCount = results.filter(r => r.success).length;
        const errorCount = results.filter(r => !r.success).length;

        if (errorCount === 0) {
          this.showMessage(`Successfully created activity code in ${successCount} business units`, 'success');
        } else {
          const errorList = results.filter(r => !r.success)
            .map(r => `â€¢ ${r.unit}: ${r.error}`)
            .join('<br>');
          
          this.showMessage(
            `Created in ${successCount} business units, failed in ${errorCount}:<br>${errorList}`,
            errorCount === results.length ? 'error' : 'success'
          );
        }
      },

      showMessage(message, type = 'info') {
        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = `<p class="${type}">${message}</p>`;
      },

      showError(error) {
        console.error(error);
        this.showMessage(`Error: ${error.message || error}`, 'error');
      }
    };

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      appController.init().catch(error => {
        console.error('Application initialization failed:', error);
        document.getElementById('results').innerHTML = 
          `<p class="error">Application failed to initialize: ${error.message}</p>`;
      });
    });
  </script>
</body>
</html>
