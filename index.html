<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Activity Code Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Proxima+Nova&display=swap" rel="stylesheet">
  <style>
    /* [Previous CSS styles remain exactly the same] */
    body {
      font-family: 'Proxima Nova', Arial, sans-serif;
      margin: 20px;
      padding: 20px;
    }
    /* [Rest of your existing CSS...] */
  </style>
</head>
<body>
  <!-- [Previous HTML structure remains the same until the script section] -->
  
  <script>
    // Function to fetch access token using Client ID and Client Secret
    async function getAccessToken() {
      const clientId = 'f93a488c-73e9-40cf-b4fd-5c05ff043c81';
      const clientSecret = 'G0qSDsjAtCutt5W-297Yqrwz9n4q3g3YdwpfnbchGcQ';
      
      const url = 'https://api.mypurecloud.ie/oauth/token';
      
      const body = new URLSearchParams();
      body.append('grant_type', 'client_credentials');
      body.append('client_id', clientId);
      body.append('client_secret', clientSecret);
      
      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: body.toString(),
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || errorData.error_description || 'Failed to authenticate');
        }
        
        const data = await response.json();
        return data.access_token;
      } catch (error) {
        console.error('Authentication error:', error);
        throw new Error(`Authentication failed: ${error.message}`);
      }
    }

    // Function to fetch all business units with proper pagination
    async function fetchBusinessUnits() {
      const resultsDiv = document.getElementById('results');
      const businessUnitsSelect = document.getElementById('business-units');
      const createButton = document.getElementById('create-button');
      
      try {
        resultsDiv.innerHTML = '<p class="loading">Loading business units...</p>';
        
        const accessToken = await getAccessToken();
        const apiUrl = 'https://api.mypurecloud.ie/api/v2/workforcemanagement/businessunits';
        
        let allBusinessUnits = [];
        let pageNumber = 1;
        const pageSize = 100;
        let totalEntities = 0;
        
        do {
          const response = await fetch(`${apiUrl}?pageNumber=${pageNumber}&pageSize=${pageSize}`, {
            method: 'GET',
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            },
          });
          
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || 'Failed to fetch business units');
          }
          
          const data = await response.json();
          allBusinessUnits = allBusinessUnits.concat(data.entities);
          
          // Update total entities and page number
          totalEntities = data.total ? data.total : allBusinessUnits.length;
          pageNumber++;
          
        } while (allBusinessUnits.length < totalEntities);
        
        // Sort business units alphabetically by name
        allBusinessUnits.sort((a, b) => a.name.localeCompare(b.name));
        
        // Populate the dropdown
        businessUnitsSelect.innerHTML = '';
        allBusinessUnits.forEach(unit => {
          // Skip business units that are not active or don't have a name
          if (unit.name && (!unit.division || unit.division.selfUri)) {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = unit.name;
            businessUnitsSelect.appendChild(option);
          }
        });
        
        if (allBusinessUnits.length === 0) {
          throw new Error('No business units found');
        }
        
        resultsDiv.innerHTML = `<p class="success">Loaded ${allBusinessUnits.length} business units</p>`;
        createButton.disabled = false;
        
      } catch (error) {
        console.error('Error loading business units:', error);
        businessUnitsSelect.innerHTML = '<option value="" disabled>Failed to load business units</option>';
        resultsDiv.innerHTML = `<p class="error">Error loading business units: ${error.message}</p>`;
        createButton.disabled = true;
        
        // Add retry button
        const retryButton = document.createElement('button');
        retryButton.textContent = 'Retry';
        retryButton.onclick = fetchBusinessUnits;
        resultsDiv.appendChild(retryButton);
      }
    }

    // [Rest of your existing JavaScript functions remain the same]
    async function createActivityCode() {
      /* Previous implementation remains exactly the same */
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', fetchBusinessUnits);
  </script>
</body>
</html>
