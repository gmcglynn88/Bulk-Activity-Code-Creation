<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Activity Code Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1200px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:end}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}

    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    .checkbox-dropdown{position:relative;min-width:260px}
    .cd-trigger{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border-color);border-radius:6px;background:#fff;padding:10px;cursor:pointer}
    .cd-trigger .label{color:var(--text-color)}
    .cd-trigger .count{background:var(--pill);border:1px solid var(--border-color);border-radius:999px;padding:2px 8px;font-size:12px;color:#2c3e50}
    .cd-panel{position:absolute;z-index:1000;margin-top:6px;background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;max-height:340px;overflow:hidden;display:none}
    .cd-panel.open{display:block}
    .cd-header{padding:10px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}
    .cd-search{flex:1;border:1px solid var(--border-color);border-radius:6px;padding:8px}
    .cd-actions{display:flex;gap:8px}
    .cd-actions button{background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);border-radius:6px;padding:8px 10px;cursor:pointer}
    .cd-selectall{padding:8px 12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px}
    .cd-list{max-height:260px;overflow:auto}
    .cd-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f3f5}
    .cd-item label{display:flex;align-items:center;gap:10px;cursor:pointer;width:100%}
    .cd-footer{padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);font-size:12px;color:var(--text-light);display:flex;justify-content:space-between}
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>Activity Code Management</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">Select Business Units</h2>
      <div class="controls">
        <div>
          <label>Business Units</label>
          <div id="businessUnitsDD" class="checkbox-dropdown"></div>
          <div class="muted">Search, tick, or use "Select all".</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="section-title">Create Activity Code</h2>
      <div class="controls">
        <div>
          <label for="activity-name">Activity Name</label>
          <input type="text" id="activity-name" placeholder="Enter activity name" />
        </div>
        <div>
          <label for="category">Category</label>
          <select id="category">
            <option value="">Select category</option>
            <option value="OnQueueWork">OnQueueWork</option>
            <option value="Break">Break</option>
            <option value="Meal">Meal</option>
            <option value="Meeting">Meeting</option>
            <option value="OffQueueWork">OffQueueWork</option>
            <option value="TimeOff">TimeOff</option>
            <option value="Training">Training</option>
            <option value="Unavailable">Unavailable</option>
            <option value="Unscheduled">Unscheduled</option>
          </select>
        </div>
        <div>
          <label for="length">Default Length (minutes)</label>
          <input type="number" id="length" placeholder="e.g. 30" />
        </div>
      </div>

      <div class="controls">
        <div>
          <label class="muted">Options</label>
          <div style="display:grid;gap:8px;">
            <label><input type="checkbox" id="paid-time"> Counts as Paid Time</label>
            <label><input type="checkbox" id="work-time"> Counts as Work Time</label>
            <label><input type="checkbox" id="time-off-selectable"> Agent Time Off Selectable</label>
            <label><input type="checkbox" id="shrinkage"> Counts Toward Shrinkage</label>
            <label><input type="checkbox" id="planned-shrinkage"> Planned Shrinkage</label>
            <label><input type="checkbox" id="interruptible"> Interruptible</label>
          </div>
        </div>
      </div>

      <button id="create-button" class="full-width-btn">Create Activity Code for Selected Business Units</button>
    </div>

    <div id="results" class="card" style="display:none;"></div>
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    
    // Use the EXACT URI that's registered in Genesys Cloud
    const redirectUri = 'https://gmcglynn88.github.io/Bulk-Activity-Code-Creation/';
    
    const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${encodeURIComponent(clientId)}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;

    // Debug logging
    console.log('OAuth Configuration:');
    console.log('- Client ID:', clientId);
    console.log('- Redirect URI:', redirectUri);
    console.log('- Encoded Redirect URI:', encodeURIComponent(redirectUri));
    console.log('- Full OAuth URL:', oauthUrl);

    let accessToken = null;
    let buDropdown = null;

    // ===== Checkbox Dropdown (generic) =====
    function createCheckboxDropdown(containerId, { placeholder='Select items', searchPlaceholder='Search...' } = {}){
      const root = document.getElementById(containerId);
      root.innerHTML = '';

      const trigger = document.createElement('div');
      trigger.className = 'cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      root.appendChild(trigger);

      const panel = document.createElement('div');
      panel.className = 'cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="${searchPlaceholder}" />
          <div class="cd-actions">
            <button type="button" data-cd="clear">Clear</button>
          </div>
        </div>
        <div class="cd-selectall">
          <label><input type="checkbox" data-cd="selectall" /> Select all</label>
        </div>
        <div class="cd-list"></div>
        <div class="cd-footer">
          <span data-cd="summary">0 selected</span>
          <span>Click outside to close</span>
        </div>
      `;
      root.appendChild(panel);

      const list = panel.querySelector('.cd-list');
      const search = panel.querySelector('.cd-search');
      const clearBtn = panel.querySelector('[data-cd="clear"]');
      const selectAll = panel.querySelector('[data-cd="selectall"]');
      const summary = panel.querySelector('[data-cd="summary"]');

      let options = []; // [{value, label}]
      let selected = new Set();

      function render(filter=''){
        const ft = filter.trim().toLowerCase();
        list.innerHTML = '';
        const filtered = !ft ? options : options.filter(o => (o.label||'').toLowerCase().includes(ft));
        if (!filtered.length){ list.innerHTML = `<div class="cd-item" style="color:#6C757D">No matches</div>`; return; }
        filtered.forEach(o=>{
          const id = `${containerId}__${o.value}`;
          const row = document.createElement('div');
          row.className = 'cd-item';
          row.innerHTML = `
            <label for="${id}">
              <input type="checkbox" id="${id}" value="${o.value}" ${selected.has(o.value)?'checked':''}/>
              <span>${o.label || o.value}</span>
            </label>
          `;
          const cb = row.querySelector('input');
          cb.addEventListener('change', ()=>{
            if (cb.checked) selected.add(o.value); else selected.delete(o.value);
            updateSummary(); updateSelectAllState();
          });
          list.appendChild(row);
        });
      }
      function updateSummary(){
        trigger.querySelector('.count').textContent = `${selected.size} selected`;
        summary.textContent = `${selected.size} selected`;
      }
      function updateSelectAllState(){
        const total = options.length, count = selected.size;
        selectAll.indeterminate = count>0 && count<total;
        selectAll.checked = total>0 && count===total;
      }

      trigger.addEventListener('click', ()=>{ panel.classList.toggle('open'); search.focus(); });
      document.addEventListener('click', (e)=>{ if (!root.contains(e.target)) panel.classList.remove('open'); });
      search.addEventListener('input', ()=> render(search.value));
      clearBtn.addEventListener('click', ()=>{ selected.clear(); render(search.value); updateSummary(); updateSelectAllState(); });
      selectAll.addEventListener('change', ()=>{
        if (selectAll.checked) options.forEach(o=> selected.add(o.value)); else selected.clear();
        render(search.value); updateSummary();
      });

      function setOptions(newOptions){
        options = newOptions || [];
        selected.forEach(v=>{ if (!options.some(o=>o.value===v)) selected.delete(v); });
        render(search.value); updateSummary(); updateSelectAllState();
      }
      function getSelectedValues(){ return Array.from(selected); }

      render('');
      return { setOptions, getSelectedValues };
    }

    // ===== Auth bootstrap =====
    document.addEventListener('DOMContentLoaded', () => {
      // Parse OAuth error from the URL
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      const qparams = new URLSearchParams(window.location.search);

      const oauthError = params.get('error') || qparams.get('error');
      const oauthErrorDesc = params.get('error_description') || qparams.get('error_description');

      if (oauthError) {
        document.getElementById('auth-message').textContent = `OAuth error: ${oauthErrorDesc || oauthError}`;
        document.getElementById('auth-message').className = 'error-message';
        console.error('OAuth error details:', { error: oauthError, description: oauthErrorDesc });
        return;
      }

      accessToken = params.get('access_token');

      if (accessToken) {
        sessionStorage.setItem('purecloud_token', accessToken);
        // Clean URL after successful auth
        window.location.hash = '';
        initializeApplication();
      } else if (sessionStorage.getItem('purecloud_token')) {
        accessToken = sessionStorage.getItem('purecloud_token');
        initializeApplication();
      } else {
        console.log('Initiating OAuth flow with:', { clientId, redirectUri });
        window.location.href = oauthUrl;
      }
    });

    function showMessage(msg, type='error'){
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${msg}</div>`;
      box.style.display = 'block';
      if (type === 'success') setTimeout(()=> box.style.display='none', 5000);
    }

    function initializeApplication() {
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';

      buDropdown = createCheckboxDropdown('businessUnitsDD', { placeholder:'Select business units', searchPlaceholder:'Search business units...' });
      fetchBusinessUnits();
      document.getElementById('create-button').addEventListener('click', createActivityCode);
    }

    // ===== Data fetch =====
    async function fetchBusinessUnits() {
      try {
        const base = 'https://api.mypurecloud.ie/api/v2/workforcemanagement/businessunits?pageSize=100';
        let businessUnits = [];
        let nextPageUrl = base;

        while (nextPageUrl) {
          const response = await fetch(nextPageUrl, {
            method: 'GET',
            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' }
          });
          const data = await response.json();

          if (response.ok) {
            businessUnits = businessUnits.concat(data.entities || []);
            nextPageUrl = (data.pageCount > data.pageNumber) ? `${base}&pageNumber=${(data.pageNumber || 1) + 1}` : null;
          } else {
            throw new Error(data.message || 'Error fetching business units');
          }
        }

        const opts = businessUnits
          .map(u => ({ value: u.id, label: u.name }))
          .sort((a,b)=> a.label.localeCompare(b.label));
        buDropdown.setOptions(opts);
      } catch (error) {
        console.error('Error in fetchBusinessUnits:', error);
        showMessage(`Error loading business units: ${error.message}`, 'error');
      }
    }

    // ===== Create Activity Code =====
    async function createActivityCode() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '';

      const name = document.getElementById('activity-name').value.trim();
      const category = document.getElementById('category').value;
      const lengthInMinutes = parseInt(document.getElementById('length').value, 10) || null;

      const businessUnits = buDropdown.getSelectedValues();

      if (!name) { resultsDiv.innerHTML = `<div class="error-message">Please enter an activity name.</div>`; return; }
      if (!category) { resultsDiv.innerHTML = `<div class="error-message">Please select a category.</div>`; return; }
      if (businessUnits.length === 0) { resultsDiv.innerHTML = `<div class="error-message">Please select at least one business unit.</div>`; return; }

      const countsAsPaidTime = document.getElementById('paid-time').checked;
      const countsAsWorkTime = document.getElementById('work-time').checked;
      const agentTimeOffSelectable = document.getElementById('time-off-selectable').checked;
      const countsTowardShrinkage = document.getElementById('shrinkage').checked;
      const plannedShrinkage = document.getElementById('planned-shrinkage').checked;
      const interruptible = document.getElementById('interruptible').checked;

      const button = document.getElementById('create-button');
      button.disabled = true;
      const originalLabel = button.textContent;
      button.textContent = 'Processing...';

      try {
        const ops = businessUnits.map(businessUnitId => (async () => {
          const createUrl = `https://api.mypurecloud.ie/api/v2/workforcemanagement/businessunits/${businessUnitId}/activitycodes`;
          const res = await fetch(createUrl, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' },
            body: JSON.stringify({
              name, category, lengthInMinutes,
              countsAsPaidTime, countsAsWorkTime, agentTimeOffSelectable,
              countsTowardShrinkage, plannedShrinkage, interruptible
            })
          });
          const data = await res.json().catch(()=> ({}));
          if (!res.ok) throw new Error(data.message || 'Unknown error');
          return { businessUnitId, ok: true };
        })());

        const results = await Promise.allSettled(ops);
        const successes = results.filter(r => r.status === 'fulfilled').map(r => r.value.businessUnitId);
        const failures = results
          .filter(r => r.status === 'rejected')
          .map((r, i) => ({ businessUnitId: businessUnits[i], error: r.reason?.message || 'Unknown error' }));

        if (failures.length === 0) {
          resultsDiv.innerHTML = `<div class="success-message">Activity code created successfully in ${successes.length} business unit(s).</div>`;
        } else if (successes.length === 0) {
          resultsDiv.innerHTML = `<div class="error-message">Failed to create activity code in all selected business units.</div>
            <ul>${failures.map(f => `<li><strong>${f.businessUnitId}</strong>: ${f.error}</li>`).join('')}</ul>`;
        } else {
          resultsDiv.innerHTML = `<div class="success-message">Created in ${successes.length} business unit(s).</div>
            <div class="error-message" style="margin-top:8px;">Failed in ${failures.length} unit(s):</div>
            <ul>${failures.map(f => `<li><strong>${f.businessUnitId}</strong>: ${f.error}</li>`).join('')}</ul>`;
        }
      } catch (error) {
        console.error('Error in createActivityCode:', error);
        resultsDiv.innerHTML = `<div class="error-message">Error creating activity code: ${error.message}</div>`;
      } finally {
        button.disabled = false;
        button.textContent = originalLabel;
      }
    }
  </script>
</body>
</html>
