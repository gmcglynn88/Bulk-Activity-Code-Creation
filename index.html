<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Activity Code Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <style>
    :root{
      --primary-color:#63AB8F; --secondary-color:#4A8C7D; --border-color:#DEE2E6;
      --light-bg:#F8F9FA; --card-bg:#FFFFFF; --text-color:#2C3E50; --text-light:#6C757D;
      --pill:#e9f6f0;
    }
    body{
      font-family:'Aptos','Segoe UI',system-ui,-apple-system,Arial,sans-serif;
      margin:20px;padding:20px;max-width:1200px;background:var(--light-bg);color:var(--text-color)
    }
    #logo-container{text-align:center;margin-bottom:20px} #logo{width:300px}
    h1{margin:0 0 16px}
    .card{background:var(--card-bg);border:1px solid var(--border-color);border-radius:12px;padding:24px;margin-top:16px;box-shadow:0 1px 3px rgba(0,0,0,.08)}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,button,textarea{padding:10px;border:1px solid var(--border-color);border-radius:6px;background:#fff;font-size:14px}
    button{background:var(--primary-color);color:#fff;font-weight:600;cursor:pointer;transition:background .2s}
    button:hover{background:var(--secondary-color)} button:disabled{background:var(--text-light);cursor:not-allowed}
    .controls{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px;align-items:end}
    .full-width-btn{width:100%;padding:14px 18px;font-size:16px;margin-top:12px}
    .muted{color:var(--text-light);font-size:12px}
    .section-title{margin:0 0 10px;color:var(--secondary-color)}

    #messageContainer{display:none;margin-top:12px}
    .error-message{color:#b4231a;background:#fee2e2;border:1px solid #fecaca;padding:10px;border-radius:6px}
    .success-message{color:#14532d;background:#dcfce7;border:1px solid #bbf7d0;padding:10px;border-radius:6px}
    .info-message{color:#6b4e16;background:#fff7ed;border:1px solid #ffedd5;padding:10px;border-radius:6px}

    .checkbox-dropdown{position:relative;min-width:260px}
    .cd-trigger{display:flex;align-items:center;justify-content:space-between;border:1px solid var(--border-color);border-radius:6px;background:#fff;padding:10px;cursor:pointer}
    .cd-trigger .label{color:var(--text-color)}
    .cd-trigger .count{background:var(--pill);border:1px solid var(--border-color);border-radius:999px;padding:2px 8px;font-size:12px;color:#2c3e50}
    .cd-panel{position:absolute;z-index:1000;margin-top:6px;background:#fff;border:1px solid var(--border-color);border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);width:100%;max-height:340px;overflow:hidden;display:none}
    .cd-panel.open{display:block}
    .cd-header{padding:10px;border-bottom:1px solid var(--border-color);display:flex;gap:8px;align-items:center}
    .cd-search{flex:1;border:1px solid var(--border-color);border-radius:6px;padding:8px}
    .cd-actions{display:flex;gap:8px}
    .cd-actions button{background:#eef6f2;color:#2c3e50;border:1px solid var(--border-color);border-radius:6px;padding:8px 10px;cursor:pointer}
    .cd-selectall{padding:8px 12px;border-bottom:1px solid var(--border-color);display:flex;align-items:center;gap:10px}
    .cd-list{max-height:260px;overflow:auto}
    .cd-item{display:flex;align-items:center;gap:10px;padding:8px 12px;border-bottom:1px solid #f1f3f5}
    .cd-item label{display:flex;align-items:center;gap:10px;cursor:pointer;width:100%}
    .cd-footer{padding:8px 12px;background:#fafafa;border-top:1px solid var(--border-color);font-size:12px;color:var(--text-light);display:flex;justify-content:space-between}
    
    /* Work Handling Settings Section */
    #workHandlingSettings { display: none; margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
    #workHandlingSettings h3 { margin: 0 0 12px; color: var(--secondary-color); font-size: 16px; }
    
    /* Business Unit Work Handling Container */
    .bu-work-handling-container { display: grid; gap: 16px; margin-top: 12px; }
    .bu-work-handling-item { border: 1px solid var(--border-color); border-radius: 8px; padding: 16px; background: var(--light-bg); }
    .bu-work-handling-item h4 { margin: 0 0 12px; color: var(--text-color); font-size: 14px; }
    .bu-work-handling-item .muted { margin-top: 4px; }
    
    /* Disabled option styling */
    .disabled-option { opacity: 0.6; cursor: not-allowed; }
    .disabled-option input[type="checkbox"] { cursor: not-allowed; }
    
    /* Loading spinner */
    .spinner { display: inline-block; width: 16px; height: 16px; border: 2px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--primary-color); animation: spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .loading { display: flex; align-items: center; gap: 8px; padding: 10px; color: var(--text-light); }
  </style>
</head>
<body>
  <div id="logo-container">
    <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo">
  </div>

  <h1>Activity Code Management</h1>

  <div id="authCard" class="card">
    <div id="auth-message" class="info-message">Authenticating with PureCloud...</div>
  </div>

  <div id="appContent" style="display:none;">
    <div id="messageContainer"></div>

    <div class="card">
      <h2 class="section-title">Select Business Units</h2>
      <div class="controls">
        <div>
          <label>Business Units</label>
          <div id="businessUnitsDD" class="checkbox-dropdown"></div>
          <div class="muted">Search, tick, or use "Select all".</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="section-title">Create Activity Code</h2>
      <div class="controls">
        <div>
          <label for="activity-name">Activity Name</label>
          <input type="text" id="activity-name" placeholder="Enter activity name" />
        </div>
        <div>
          <label for="category">Category</label>
          <select id="category">
            <option value="">Select category</option>
            <option value="OnQueueWork">On Queue</option>
            <option value="Break">Break</option>
            <option value="Meal">Meal</option>
            <option value="Meeting">Meeting</option>
            <option value="OffQueueWork">Off Queue</option>
            <option value="TimeOff">Time Off</option>
            <option value="Training">Training</option>
            <option value="Unavailable">Unavailable</option>
            <option value="Unscheduled">Unscheduled</option>
          </select>
        </div>
        <div>
          <label for="length">Default Length (minutes)</label>
          <input type="number" id="length" placeholder="e.g. 30" />
        </div>
      </div>

      <div class="controls">
        <div>
          <label class="muted">Options</label>
          <div style="display:grid;gap:8px;">
            <label id="paid-time-label"><input type="checkbox" id="paid-time"> Counts as Paid Time</label>
            <label id="work-time-label"><input type="checkbox" id="work-time"> Counts as Work Time</label>
            <label id="time-off-selectable-label"><input type="checkbox" id="time-off-selectable"> Agent Time Off Selectable</label>
            <label id="shrinkage-label"><input type="checkbox" id="shrinkage"> Counts Toward Shrinkage</label>
            <label id="planned-shrinkage-label"><input type="checkbox" id="planned-shrinkage"> Planned Shrinkage</label>
            <label id="interruptible-label"><input type="checkbox" id="interruptible"> Interruptible</label>
          </div>
        </div>
      </div>

      <!-- Work Handling Settings Section (Visible only for On Queue) -->
      <div id="workHandlingSettings">
        <h3>Work Handling Settings (Optional)</h3>
        <div class="muted" style="margin-bottom: 12px;">Select planning groups that can be supported by this activity. If none selected, activity will be available to all planning groups.</div>
        <div id="workHandlingBUs" class="bu-work-handling-container">
          <!-- Business unit work handling items will be dynamically added here -->
        </div>
      </div>

      <button id="create-button" class="full-width-btn">Create Activity Code for Selected Business Units</button>
    </div>

    <div id="results" class="card" style="display:none;"></div>
  </div>

  <script>
    // ===== OAuth Config =====
    const clientId = 'fe305808-b368-4547-8af9-325d28d552bb';
    const redirectUri = 'https://gmcglynn88.github.io/Bulk-Activity-Code-Creation/';
    const oauthUrl = `https://login.mypurecloud.ie/oauth/authorize?client_id=${encodeURIComponent(clientId)}&response_type=token&redirect_uri=${encodeURIComponent(redirectUri)}`;

    let accessToken = null;
    let buDropdown = null;
    let businessUnitsData = [];
    let planningGroupsData = new Map();

    // ===== SIMPLE Checkbox Dropdown =====
    function createSimpleCheckboxDropdown(containerId, placeholder = 'Select items') {
      console.log(`Creating dropdown for ${containerId}`);
      const container = document.getElementById(containerId);
      if (!container) {
        console.error(`Container ${containerId} not found`);
        return null;
      }
      
      // Clear container
      container.innerHTML = '';
      
      // Create trigger
      const trigger = document.createElement('div');
      trigger.className = 'cd-trigger';
      trigger.innerHTML = `<span class="label">${placeholder}</span><span class="count">0 selected</span>`;
      container.appendChild(trigger);
      
      // Create panel
      const panel = document.createElement('div');
      panel.className = 'cd-panel';
      panel.innerHTML = `
        <div class="cd-header">
          <input type="text" class="cd-search" placeholder="Search..." />
        </div>
        <div class="cd-selectall">
          <label><input type="checkbox" class="select-all"> Select all</label>
        </div>
        <div class="cd-list"></div>
        <div class="cd-footer">
          <span class="summary">0 selected</span>
          <span>Click outside to close</span>
        </div>
      `;
      container.appendChild(panel);
      
      const searchInput = panel.querySelector('.cd-search');
      const selectAllCheckbox = panel.querySelector('.select-all');
      const listContainer = panel.querySelector('.cd-list');
      const summary = panel.querySelector('.summary');
      
      let options = [];
      let selected = new Set();
      
      function renderList(filterText = '') {
        listContainer.innerHTML = '';
        const filtered = filterText ? 
          options.filter(opt => opt.label.toLowerCase().includes(filterText.toLowerCase())) : 
          options;
        
        if (filtered.length === 0) {
          listContainer.innerHTML = '<div class="cd-item" style="color:#6C757D">No items found</div>';
          return;
        }
        
        filtered.forEach(option => {
          const item = document.createElement('div');
          item.className = 'cd-item';
          const checkboxId = `${containerId}_${option.value}`;
          item.innerHTML = `
            <label for="${checkboxId}">
              <input type="checkbox" id="${checkboxId}" value="${option.value}" ${selected.has(option.value) ? 'checked' : ''}>
              <span>${option.label}</span>
            </label>
          `;
          
          const checkbox = item.querySelector('input');
          checkbox.addEventListener('change', () => {
            if (checkbox.checked) {
              selected.add(option.value);
            } else {
              selected.delete(option.value);
            }
            updateUI();
          });
          
          listContainer.appendChild(item);
        });
      }
      
      function updateUI() {
        // Update trigger count
        trigger.querySelector('.count').textContent = `${selected.size} selected`;
        
        // Update summary
        summary.textContent = `${selected.size} selected`;
        
        // Update select all state
        selectAllCheckbox.checked = options.length > 0 && selected.size === options.length;
        selectAllCheckbox.indeterminate = selected.size > 0 && selected.size < options.length;
      }
      
      // Event listeners
      trigger.addEventListener('click', () => {
        panel.classList.toggle('open');
        if (panel.classList.contains('open')) {
          searchInput.focus();
        }
      });
      
      document.addEventListener('click', (e) => {
        if (!container.contains(e.target)) {
          panel.classList.remove('open');
        }
      });
      
      searchInput.addEventListener('input', (e) => {
        renderList(e.target.value);
      });
      
      selectAllCheckbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          options.forEach(opt => selected.add(opt.value));
        } else {
          selected.clear();
        }
        renderList(searchInput.value);
        updateUI();
      });
      
      // Initialize
      renderList();
      updateUI();
      
      return {
        setOptions: (newOptions) => {
          console.log(`Setting options for ${containerId}:`, newOptions);
          options = newOptions || [];
          // Clear selections that don't exist in new options
          selected.forEach(val => {
            if (!options.some(opt => opt.value === val)) {
              selected.delete(val);
            }
          });
          renderList(searchInput.value);
          updateUI();
        },
        getSelectedValues: () => Array.from(selected),
        clearSelection: () => {
          selected.clear();
          renderList(searchInput.value);
          updateUI();
        }
      };
    }

    // ===== Auth bootstrap =====
    document.addEventListener('DOMContentLoaded', () => {
      const hash = window.location.hash.substring(1);
      const params = new URLSearchParams(hash);
      
      const oauthError = params.get('error');
      const oauthErrorDesc = params.get('error_description');
      
      if (oauthError) {
        document.getElementById('auth-message').textContent = `OAuth error: ${oauthErrorDesc || oauthError}`;
        document.getElementById('auth-message').className = 'error-message';
        return;
      }
      
      accessToken = params.get('access_token');
      
      if (accessToken) {
        sessionStorage.setItem('purecloud_token', accessToken);
        window.location.hash = '';
        initializeApplication();
      } else if (sessionStorage.getItem('purecloud_token')) {
        accessToken = sessionStorage.getItem('purecloud_token');
        initializeApplication();
      } else {
        window.location.href = oauthUrl;
      }
    });
    
    function showMessage(msg, type='error'){
      const box = document.getElementById('messageContainer');
      box.innerHTML = `<div class="${type}-message">${msg}</div>`;
      box.style.display = 'block';
      if (type === 'success') setTimeout(()=> box.style.display='none', 5000);
    }
    
    function initializeApplication() {
      document.getElementById('auth-message').textContent = 'Authenticated successfully!';
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('appContent').style.display = 'block';
      
      // Create business units dropdown
      buDropdown = createSimpleCheckboxDropdown('businessUnitsDD', 'Select business units');
      
      fetchBusinessUnits();
      
      // Add event listeners
      document.getElementById('category').addEventListener('change', handleCategoryChange);
      document.getElementById('create-button').addEventListener('click', createActivityCode);
    }
    
    // Handle category change
    function handleCategoryChange() {
      const category = document.getElementById('category').value;
      const workHandlingSettings = document.getElementById('workHandlingSettings');
      
      // Update checkbox states based on category
      updateCheckboxStatesForCategory(category);
      
      if (category === 'OnQueueWork') {
        workHandlingSettings.style.display = 'block';
        updateWorkHandlingSections();
      } else {
        workHandlingSettings.style.display = 'none';
        planningGroupsData.clear();
      }
    }
    
    // Update checkbox states based on category
    function updateCheckboxStatesForCategory(category) {
      const checkboxes = [
        { id: 'shrinkage', labelId: 'shrinkage-label' },
        { id: 'planned-shrinkage', labelId: 'planned-shrinkage-label' },
        { id: 'interruptible', labelId: 'interruptible-label' },
        { id: 'work-time', labelId: 'work-time-label' },
        { id: 'time-off-selectable', labelId: 'time-off-selectable-label' }
      ];
      
      // Reset all
      checkboxes.forEach(({ id, labelId }) => {
        const checkbox = document.getElementById(id);
        const label = document.getElementById(labelId);
        if (checkbox && label) {
          checkbox.disabled = false;
          label.classList.remove('disabled-option');
        }
      });
      
      if (category === 'OnQueueWork') {
        // On Queue rules
        document.getElementById('shrinkage').checked = false;
        document.getElementById('shrinkage').disabled = true;
        document.getElementById('shrinkage-label').classList.add('disabled-option');
        
        document.getElementById('planned-shrinkage').checked = false;
        document.getElementById('planned-shrinkage').disabled = true;
        document.getElementById('planned-shrinkage-label').classList.add('disabled-option');
        
        document.getElementById('interruptible').disabled = true;
        document.getElementById('interruptible-label').classList.add('disabled-option');
        
        document.getElementById('work-time').checked = true;
        document.getElementById('work-time').disabled = true;
        document.getElementById('work-time-label').classList.add('disabled-option');
        
        document.getElementById('time-off-selectable').checked = false;
        document.getElementById('time-off-selectable').disabled = true;
        document.getElementById('time-off-selectable-label').classList.add('disabled-option');
      }
    }
    
    // Update work handling sections
    async function updateWorkHandlingSections() {
      console.log('Updating work handling sections');
      const workHandlingBUs = document.getElementById('workHandlingBUs');
      workHandlingBUs.innerHTML = '';
      planningGroupsData.clear();
      
      const selectedBUs = buDropdown.getSelectedValues();
      console.log('Selected BUs:', selectedBUs);
      
      if (selectedBUs.length === 0) {
        workHandlingBUs.innerHTML = '<div class="muted">Please select business units above to configure work handling settings.</div>';
        return;
      }
      
      // Process BUs one at a time to avoid overwhelming the API
      for (const buId of selectedBUs) {
        const buData = businessUnitsData.find(bu => bu.id === buId);
        if (!buData) {
          console.warn(`Business unit data not found for ID: ${buId}`);
          continue;
        }
        
        // Create container for this BU
        const containerId = `workHandling_${buId}`;
        const container = document.createElement('div');
        container.id = containerId;
        container.className = 'bu-work-handling-item';
        container.innerHTML = `
          <h4>${buData.name}</h4>
          <div class="checkbox-dropdown" id="${containerId}_dropdown"></div>
          <div class="muted" id="${containerId}_status">Loading planning groups...</div>
        `;
        workHandlingBUs.appendChild(container);
        
        // Create empty dropdown immediately
        const dropdown = createSimpleCheckboxDropdown(`${containerId}_dropdown`, 'Select planning groups...');
        if (dropdown) {
          // Store in our map
          planningGroupsData.set(buId, {
            dropdown: dropdown,
            buName: buData.name
          });
          
          // Fetch planning groups one at a time with delay
          try {
            await fetchPlanningGroups(buId);
          } catch (error) {
            console.error(`Failed to fetch planning groups for ${buData.name}:`, error);
            const statusDiv = document.getElementById(`${containerId}_status`);
            if (statusDiv) {
              statusDiv.textContent = `Error loading planning groups: ${error.message}`;
              statusDiv.style.color = '#b4231a';
            }
          }
        }
      }
    }
    
    // Fetch business units
    async function fetchBusinessUnits() {
      try {
        console.log('Fetching business units...');
        const response = await fetch('https://api.mypurecloud.ie/api/v2/workforcemanagement/businessunits?pageSize=100', {
          headers: {
            'Authorization': `Bearer ${accessToken}`,
            'Content-Type': 'application/json'
          }
        });
        
        console.log('Business units response status:', response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        businessUnitsData = data.entities || [];
        console.log(`Found ${businessUnitsData.length} business units`);
        
        const options = businessUnitsData
          .map(bu => ({ value: bu.id, label: bu.name }))
          .sort((a, b) => a.label.localeCompare(b.label));
        
        buDropdown.setOptions(options);
        
        // Listen for changes to business unit selection
        const businessUnitsContainer = document.getElementById('businessUnitsDD');
        if (businessUnitsContainer) {
          // Simple click handler to detect changes
          businessUnitsContainer.addEventListener('click', () => {
            setTimeout(() => {
              if (document.getElementById('category').value === 'OnQueueWork') {
                updateWorkHandlingSections();
              }
            }, 300); // Give time for selection to update
          });
        }
        
      } catch (error) {
        console.error('Error fetching business units:', error);
        showMessage(`Error loading business units: ${error.message}`, 'error');
      }
    }
    
    // Fetch planning groups for a business unit
    async function fetchPlanningGroups(businessUnitId) {
      console.log(`Fetching planning groups for BU: ${businessUnitId}`);
      const planningGroupInfo = planningGroupsData.get(businessUnitId);
      if (!planningGroupInfo) {
        console.error(`No planning group info found for BU: ${businessUnitId}`);
        return;
      }
      
      const container = document.getElementById(`workHandling_${businessUnitId}`);
      if (!container) {
        console.error(`Container not found for BU: ${businessUnitId}`);
        return;
      }
      
      try {
        // Update status
        const statusDiv = document.getElementById(`workHandling_${businessUnitId}_status`);
        if (statusDiv) {
          statusDiv.innerHTML = '<span class="loading"><span class="spinner"></span>Loading planning groups...</span>';
        }
        
        // Make API call
        const response = await fetch(
          `https://api.mypurecloud.ie/api/v2/workforcemanagement/businessunits/${businessUnitId}/planninggroups?pageSize=100`,
          {
            headers: {
              'Authorization': `Bearer ${accessToken}`,
              'Content-Type': 'application/json'
            }
          }
        );
        
        console.log(`Planning groups response for ${businessUnitId}:`, response.status);
        
        if (!response.ok) {
          const errorText = await response.text();
          throw new Error(`HTTP ${response.status}: ${errorText}`);
        }
        
        const data = await response.json();
        const planningGroups = data.entities || [];
        console.log(`Found ${planningGroups.length} planning groups for BU ${businessUnitId}`);
        
        const options = planningGroups
          .map(pg => ({ 
            value: pg.id, 
            label: pg.name || `Planning Group ${pg.id}` 
          }))
          .sort((a, b) => a.label.localeCompare(b.label));
        
        // Update dropdown with planning groups
        planningGroupInfo.dropdown.setOptions(options);
        
        // Update status message
        if (statusDiv) {
          if (options.length === 0) {
            statusDiv.textContent = 'No planning groups found';
          } else {
            statusDiv.textContent = `Select planning groups (optional) - ${options.length} available`;
          }
        }
        
      } catch (error) {
        console.error(`Error fetching planning groups for BU ${businessUnitId}:`, error);
        
        const statusDiv = document.getElementById(`workHandling_${businessUnitId}_status`);
        if (statusDiv) {
          statusDiv.textContent = `Error loading planning groups: ${error.message}`;
          statusDiv.style.color = '#b4231a';
        }
        
        // Set empty options on error
        planningGroupInfo.dropdown.setOptions([]);
        
        throw error; // Re-throw for calling function
      }
    }
    
    // Create activity code
    async function createActivityCode() {
      const resultsDiv = document.getElementById('results');
      resultsDiv.style.display = 'block';
      resultsDiv.innerHTML = '';
      
      // Get form values
      const name = document.getElementById('activity-name').value.trim();
      const category = document.getElementById('category').value;
      const lengthInMinutes = parseInt(document.getElementById('length').value, 10) || null;
      const businessUnits = buDropdown.getSelectedValues();
      
      // Validation
      if (!name) { resultsDiv.innerHTML = `<div class="error-message">Please enter an activity name.</div>`; return; }
      if (!category) { resultsDiv.innerHTML = `<div class="error-message">Please select a category.</div>`; return; }
      if (businessUnits.length === 0) { resultsDiv.innerHTML = `<div class="error-message">Please select at least one business unit.</div>`; return; }
      
      // Get checkbox values
      const countsAsPaidTime = document.getElementById('paid-time').checked;
      const countsAsWorkTime = document.getElementById('work-time').checked;
      const agentTimeOffSelectable = document.getElementById('time-off-selectable').checked;
      const countsTowardShrinkage = document.getElementById('shrinkage').checked;
      const plannedShrinkage = document.getElementById('planned-shrinkage').checked;
      const interruptible = document.getElementById('interruptible').checked;
      
      // Category-specific validation
      if (category === 'OnQueueWork') {
        if (countsTowardShrinkage) {
          resultsDiv.innerHTML = `<div class="error-message">"Counts Toward Shrinkage" cannot be true for On Queue activities.</div>`;
          return;
        }
        if (plannedShrinkage) {
          resultsDiv.innerHTML = `<div class="error-message">"Planned Shrinkage" cannot be true for On Queue activities.</div>`;
          return;
        }
        if (!countsAsWorkTime) {
          resultsDiv.innerHTML = `<div class="error-message">"Counts as Work Time" must be true for On Queue activities.</div>`;
          return;
        }
        if (agentTimeOffSelectable) {
          resultsDiv.innerHTML = `<div class="error-message">"Agent Time Off Selectable" cannot be true for On Queue activities.</div>`;
          return;
        }
      }
      
      // Disable button during processing
      const button = document.getElementById('create-button');
      button.disabled = true;
      const originalText = button.textContent;
      button.textContent = 'Processing...';
      
      try {
        // Create activity code in each selected business unit
        const promises = businessUnits.map(businessUnitId => {
          return (async () => {
            const createUrl = `https://api.mypurecloud.ie/api/v2/workforcemanagement/businessunits/${businessUnitId}/activitycodes`;
            
            // Build activity data
            const activityData = {
              name,
              category,
              lengthInMinutes,
              countsAsPaidTime,
              countsAsWorkTime,
              agentTimeOffSelectable,
              countsTowardShrinkage,
              plannedShrinkage,
              interruptible
            };
            
            // Add planning groups if category is OnQueueWork
            if (category === 'OnQueueWork') {
              const planningGroupInfo = planningGroupsData.get(businessUnitId);
              if (planningGroupInfo && planningGroupInfo.dropdown) {
                const planningGroupIds = planningGroupInfo.dropdown.getSelectedValues();
                if (planningGroupIds.length > 0) {
                  activityData.planningGroupIds = planningGroupIds;
                }
              }
            }
            
            console.log(`Creating activity for BU ${businessUnitId}:`, activityData);
            
            // Make API call
            const response = await fetch(createUrl, {
              method: 'POST',
              headers: {
                'Authorization': `Bearer ${accessToken}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(activityData)
            });
            
            const data = await response.json().catch(() => ({}));
            
            if (!response.ok) {
              throw new Error(data.message || `HTTP ${response.status}: ${JSON.stringify(data)}`);
            }
            
            return { businessUnitId, success: true };
          })();
        });
        
        // Wait for all promises to settle
        const results = await Promise.allSettled(promises);
        
        // Process results
        const successes = [];
        const failures = [];
        
        results.forEach((result, index) => {
          const businessUnitId = businessUnits[index];
          if (result.status === 'fulfilled') {
            successes.push(businessUnitId);
          } else {
            failures.push({
              businessUnitId,
              error: result.reason?.message || 'Unknown error'
            });
          }
        });
        
        // Display results
        if (failures.length === 0) {
          resultsDiv.innerHTML = `<div class="success-message">Successfully created activity code in ${successes.length} business unit(s).</div>`;
        } else if (successes.length === 0) {
          resultsDiv.innerHTML = `<div class="error-message">Failed to create activity code in all business units.</div>
            <ul>${failures.map(f => `<li><strong>${f.businessUnitId}</strong>: ${f.error}</li>`).join('')}</ul>`;
        } else {
          resultsDiv.innerHTML = `
            <div class="success-message">Created in ${successes.length} business unit(s).</div>
            <div class="error-message" style="margin-top:8px;">Failed in ${failures.length} business unit(s):</div>
            <ul>${failures.map(f => `<li><strong>${f.businessUnitId}</strong>: ${f.error}</li>`).join('')}</ul>
          `;
        }
        
      } catch (error) {
        console.error('Error creating activity codes:', error);
        resultsDiv.innerHTML = `<div class="error-message">Error: ${error.message}</div>`;
      } finally {
        // Re-enable button
        button.disabled = false;
        button.textContent = originalText;
      }
    }
  </script>
</body>
</html>
