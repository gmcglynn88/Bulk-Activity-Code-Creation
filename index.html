<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Activity Code Management</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Proxima+Nova&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Proxima Nova', Arial, sans-serif;
      margin: 20px;
      padding: 20px;
      background-color: #f5f5f5;
    }
    #logo-container {
      text-align: center;
      margin-bottom: 20px;
    }
    #logo {
      width: 300px;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      max-width: 800px;
      margin: 0 auto;
    }
    label {
      display: block;
      margin: 10px 0 5px;
      font-weight: bold;
    }
    select, input, button {
      padding: 10px;
      width: 100%;
      max-width: 400px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 16px;
    }
    select[multiple] {
      height: 150px;
    }
    button {
      background-color: #007bff;
      color: white;
      border: none;
      cursor: pointer;
      padding: 12px 20px;
      font-size: 16px;
      transition: background-color 0.3s;
    }
    button:hover {
      background-color: #0056b3;
    }
    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    .checkbox-container {
      display: flex;
      align-items: center;
      margin: 8px 0;
    }
    .checkbox-container input {
      width: auto;
      margin-right: 10px;
    }
    #results {
      margin: 20px 0;
      padding: 15px;
      border-radius: 4px;
    }
    .error {
      color: #dc3545;
      background-color: #f8d7da;
      border: 1px solid #f5c6cb;
    }
    .success {
      color: #28a745;
      background-color: #d4edda;
      border: 1px solid #c3e6cb;
    }
    .loading {
      color: #6c757d;
      font-style: italic;
    }
    .section {
      margin-bottom: 25px;
      padding-bottom: 25px;
      border-bottom: 1px solid #eee;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="logo-container">
      <img id="logo" src="https://raw.githubusercontent.com/gmcglynn88/Management-Unit-Search/main/Consultinglogo%20(2).png" alt="Company Logo" onerror="this.src='data:image/svg+xml;charset=UTF-8,%3Csvg xmlns=\"http://www.w3.org/2000/svg\" width=\"300\" height=\"100\" viewBox=\"0 0 300 100\"%3E%3Crect width=\"300\" height=\"100\" fill=\"%23f5f5f5\"%3E%3C/rect%3E%3Ctext x=\"150\" y=\"50\" font-family=\"Arial\" font-size=\"20\" text-anchor=\"middle\" fill=\"%23666\"%3ECompany Logo%3C/text%3E%3C/svg%3E'">
    </div>

    <h1>Manage Business Units and Activity Codes</h1>

    <div class="section">
      <label for="business-units">Select Business Units:</label>
      <select id="business-units" multiple>
        <option value="" disabled>Loading business units...</option>
      </select>
    </div>

    <div class="section">
      <h2>Create Activity Code</h2>

      <label for="activity-name">Activity Name:</label>
      <input type="text" id="activity-name" placeholder="Enter activity name" required>

      <label for="category">Category:</label>
      <select id="category" required>
        <option value="">Select category</option>
        <option value="OnQueueWork">OnQueueWork</option>
        <option value="Break">Break</option>
        <option value="Meal">Meal</option>
        <option value="Meeting">Meeting</option>
        <option value="OffQueueWork">OffQueueWork</option>
        <option value="TimeOff">TimeOff</option>
        <option value="Training">Training</option>
        <option value="Unavailable">Unavailable</option>
        <option value="Unscheduled">Unscheduled</option>
      </select>

      <label for="length">Default Length (minutes):</label>
      <input type="number" id="length" placeholder="Enter default length">

      <label>Options:</label>
      <div class="checkbox-container">
        <input type="checkbox" id="paid-time">
        <label for="paid-time">Counts as Paid Time</label>
      </div>
      <div class="checkbox-container">
        <input type="checkbox" id="work-time">
        <label for="work-time">Counts as Work Time</label>
      </div>
      <div class="checkbox-container">
        <input type="checkbox" id="time-off-selectable">
        <label for="time-off-selectable">Agent Time Off Selectable</label>
      </div>
      <div class="checkbox-container">
        <input type="checkbox" id="shrinkage">
        <label for="shrinkage">Counts Toward Shrinkage</label>
      </div>
      <div class="checkbox-container">
        <input type="checkbox" id="planned-shrinkage">
        <label for="planned-shrinkage">Planned Shrinkage</label>
      </div>
      <div class="checkbox-container">
        <input type="checkbox" id="interruptible">
        <label for="interruptible">Interruptible</label>
      </div>
    </div>

    <button id="create-button" disabled>Create Activity Code</button>

    <div id="results">
      <p class="loading">Initializing application...</p>
    </div>
  </div>

  <script>
    // Configuration
    const API_BASE_URL = 'https://api.mypurecloud.ie';
    const CLIENT_ID = 'f93a488c-73e9-40cf-b4fd-5c05ff043c81';
    const CLIENT_SECRET = 'G0qSDsjAtCutt5W-297Yqrwz9n4q3g3YdwpfnbchGcQ';

    // DOM Elements
    const resultsDiv = document.getElementById('results');
    const businessUnitsSelect = document.getElementById('business-units');
    const createButton = document.getElementById('create-button');

    // Utility functions
    function showMessage(message, type = 'info') {
      resultsDiv.innerHTML = `<p class="${type}">${message}</p>`;
    }

    function showError(error) {
      console.error(error);
      showMessage(`Error: ${error.message || error}`, 'error');
    }

    // API Functions
    async function getAccessToken() {
      try {
        const response = await fetch(`${API_BASE_URL}/oauth/token`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            grant_type: 'client_credentials',
            client_id: CLIENT_ID,
            client_secret: CLIENT_SECRET
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Authentication failed');
        }

        const data = await response.json();
        return data.access_token;
      } catch (error) {
        showError(error);
        return null;
      }
    }

    async function fetchBusinessUnits() {
      try {
        showMessage('Loading business units...', 'loading');
        createButton.disabled = true;

        const token = await getAccessToken();
        if (!token) return;

        const response = await fetch(`${API_BASE_URL}/api/v2/workforcemanagement/businessunits?pageSize=100`, {
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Failed to load business units');
        }

        const data = await response.json();
        businessUnitsSelect.innerHTML = '';
        
        // Add business units to select
        data.entities.forEach(unit => {
          if (unit.name) {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = unit.name;
            businessUnitsSelect.appendChild(option);
          }
        });

        document.getElementById('create-button').disabled = false;
        showMessage('Ready to create activity codes', 'success');
      } catch (error) {
        showError(error);
        businessUnitsSelect.innerHTML = '<option value="" disabled>Failed to load business units</option>';
      }
    }

    async function createActivityCode() {
      try {
        // Validate inputs
        const name = document.getElementById('activity-name').value.trim();
        const category = document.getElementById('category').value;
        const selectedUnits = Array.from(businessUnitsSelect.selectedOptions);
        
        if (!name) throw new Error('Activity name is required');
        if (!category) throw new Error('Category is required');
        if (selectedUnits.length === 0) throw new Error('Select at least one business unit');

        showMessage('Creating activity code...', 'loading');
        createButton.disabled = true;

        const token = await getAccessToken();
        if (!token) return;

        // Create activity code data
        const activityData = {
          name: name,
          category: category,
          lengthInMinutes: parseInt(document.getElementById('length').value) || null,
          countsAsPaidTime: document.getElementById('paid-time').checked,
          countsAsWorkTime: document.getElementById('work-time').checked,
          agentTimeOffSelectable: document.getElementById('time-off-selectable').checked,
          countsTowardShrinkage: document.getElementById('shrinkage').checked,
          plannedShrinkage: document.getElementById('planned-shrinkage').checked,
          interruptible: document.getElementById('interruptible').checked
        };

        // Create in each selected business unit
        const results = [];
        for (const unit of selectedUnits) {
          try {
            const response = await fetch(
              `${API_BASE_URL}/api/v2/workforcemanagement/businessunits/${unit.value}/activitycodes`,
              {
                method: 'POST',
                headers: {
                  'Authorization': `Bearer ${token}`,
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify(activityData)
              }
            );

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(`Failed for ${unit.textContent}: ${errorData.message}`);
            }

            const data = await response.json();
            results.push({ success: true, unit: unit.textContent, data });
          } catch (error) {
            results.push({ success: false, unit: unit.textContent, error: error.message });
          }
        }

        // Show results
        const successCount = results.filter(r => r.success).length;
        const errorCount = results.filter(r => !r.success).length;

        if (errorCount === 0) {
          showMessage(`Successfully created activity code in ${successCount} business units`, 'success');
        } else {
          const errorList = results.filter(r => !r.success)
            .map(r => `• ${r.unit}: ${r.error}`)
            .join('<br>');
          
          showMessage(
            `Created in ${successCount} business units, failed in ${errorCount}:<br>${errorList}`,
            errorCount === selectedUnits.length ? 'error' : 'success'
          );
        }
      } catch (error) {
        showError(error);
      } finally {
        createButton.disabled = false;
      }
    }

    // Initialize app
    document.addEventListener('DOMContentLoaded', () => {
      try {
        // Set up create button
        createButton.addEventListener('click', createActivityCode);
        
        // Load business units
        fetchBusinessUnits();
      } catch (error) {
        showError('Failed to initialize application: ' + error.message);
      }
    });
  </script>
</body>
</html>
